openapi: 3.1.0
info:
  title: UNICC AI Safety Reviewer API
  version: "0.1.0"
  description: |
    Contract for the AI Safety Reviewer service (UI/Agent backend).
    OpenAPI 3.1.0 with JSON Schema 2020-12 alignment.
jsonSchemaDialect: "https://json-schema.org/draft/2020-12/schema"
servers:
  - url: https://api.unicc-safety.example
    description: Production
  - url: https://sandbox.unicc-safety.example
    description: Sandbox
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  headers:
    Retry-After:
      description: Number of seconds to wait before retrying (RFC 6585 / RFC 9110).
      schema:
        type: string
        pattern: "^[0-9]+$|^.+$"
    RateLimit-Policy:
      description: Optional ratelimit policy descriptor (IETF draft).
      schema:
        type: string
    RateLimit:
      description: Optional current limit window usage summary (IETF draft).
      schema:
        type: string
  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      description: |
        Ensures POST is processed once. Reuse of the same key with an identical request is treated as the same operation;
        reuse with a different payload returns 409 Conflict. See HTTP Idempotency-Key header draft.
      schema:
        type: string
  responses:
    ErrorResponse:
      description: Error payload
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: Missing/invalid bearer token
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: Authenticated but not authorized for the requested scope
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    RateLimited:
      description: Too many requests
      headers:
        Retry-After:
          $ref: "#/components/headers/Retry-After"
        RateLimit-Policy:
          $ref: "#/components/headers/RateLimit-Policy"
        RateLimit:
          $ref: "#/components/headers/RateLimit"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
  schemas:
    ReviewRequest:
      type: object
      required: [input]
      properties:
        input:
          description: String or JSON input to review
          oneOf:
            - type: string
            - type: object
        context:
          type: object
          description: Arbitrary context (user role, locale, channel, etc.)
          additionalProperties: true
        trace_id:
          type: string
          format: uuid
          description: Optional client-generated trace ID
    ReviewResponse:
      type: object
      required: [id, decision, hazards, latency_ms, created_at]
      properties:
        id:
          type: string
          format: uuid
        decision:
          type: string
          enum: [allow, block, review, revise]
        hazards:
          type: array
          items:
            $ref: "#/components/schemas/Hazard"
        reason_codes:
          type: array
          items:
            type: string
        latency_ms:
          type: integer
          minimum: 0
        created_at:
          type: string
          format: date-time
    Hazard:
      type: object
      required: [id, name, severity, owasp_llm]
      properties:
        id:
          type: string
          description: H01..H10
        name:
          type: string
        severity:
          type: string
          enum: [low, medium, high, critical]
        owasp_llm:
          type: string
          description: OWASP LLM Top-10 reference (e.g., LLM01, LLM05)
        un_principle:
          type: string
          description: Optional UN/UNESCO principle tag
        decision_code:
          type: string
          description: Default decision for the hazard (e.g., BLOCK, REVIEW)
    EvidenceBundle:
      type: object
      required: [review_id, inputs, outputs, logs]
      properties:
        review_id:
          type: string
          format: uuid
        inputs:
          type: object
          additionalProperties: true
        outputs:
          type: object
          additionalProperties: true
        logs:
          type: array
          items:
            $ref: "#/components/schemas/LogEntry"
        attachments:
          type: array
          description: Optional attachments; may be delivered out-of-band in ZIP
          items:
            $ref: "#/components/schemas/Attachment"
    LogEntry:
      type: object
      properties:
        ts:
          type: string
          format: date-time
        level:
          type: string
          enum: [DEBUG, INFO, WARN, ERROR]
        message:
          type: string
        fields:
          type: object
          additionalProperties: true
    Attachment:
      type: object
      required: [id, filename, contentType]
      properties:
        id:
          type: string
        filename:
          type: string
        contentType:
          type: string
        sha256:
          type: string
    ErrorResponse:
      type: object
      required: [code, message, trace_id]
      properties:
        code:
          type: string
          description: Canonical application error code
          enum:
            - BAD_REQUEST
            - UNAUTHORIZED
            - FORBIDDEN
            - NOT_FOUND
            - CONFLICT
            - UNPROCESSABLE
            - RATE_LIMITED
            - INTERNAL
            - UNAVAILABLE
        message:
          type: string
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              issue:
                type: string
        trace_id:
          type: string
          description: Correlates client/server logs
security:
  - bearerAuth: []
paths:
  /v1/review:
    post:
      summary: Submit input for safety review
      description: Create a new review; supports idempotency via Idempotency-Key header.
      operationId: createReview
      parameters:
        - $ref: "#/components/parameters/IdempotencyKey"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReviewRequest"
      responses:
        "201":
          description: Created
          headers:
            Location:
              description: URL of the created review resource
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReviewResponse"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          description: Idempotency conflict (same Idempotency-Key with different payload)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Unprocessable â€“ policy/classifier failure to evaluate request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/ErrorResponse"
        "503":
          $ref: "#/components/responses/ErrorResponse"
      security:
        - bearerAuth: []
      x-required-scopes:
        - review.write
  /v1/review/{id}:
    get:
      summary: Fetch a review record
      operationId: getReview
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReviewResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/ErrorResponse"
      security:
        - bearerAuth: []
      x-required-scopes:
        - review.read
  /v1/policy/hazards:
    get:
      summary: List hazard taxonomy and decision codes
      operationId: listHazards
      parameters:
        - name: version
          in: query
          required: false
          schema:
            type: string
        - name: include_decisions
          in: query
          required: false
          schema:
            type: boolean
            default: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Hazard"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/ErrorResponse"
      security:
        - bearerAuth: []
      x-required-scopes:
        - policy.read
  /v1/evidence/{review_id}:
    get:
      summary: Download evidence bundle for a review
      operationId: getEvidence
      parameters:
        - name: review_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: OK
          content:
            application/zip:
              schema:
                type: string
                format: binary
            application/json:
              schema:
                $ref: "#/components/schemas/EvidenceBundle"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"
        "429":
          $ref: "#/components/responses/RateLimited"
        "500":
          $ref: "#/components/responses/ErrorResponse"
      security:
        - bearerAuth: []
      x-required-scopes:
        - evidence.read
